#' Simulate CDM data
#'
#'@param Nskill Number of skills to simulate
#'@param seed Fix seed for reproducibility
#'@return Returns simulated X and Q-matrix
#'@export
simulated_cdm_data<-function(Nskill=3,Nresp_per_profile=20,
                             Nq_per_profile=3,seed=123,time_points=2){
  if(!is.na(seed)){
    set.seed(seed)
  }
  Nprofile=2^Nskill

  profile_list=list()
  for(ii in 1:(2^Nskill)){
    tmp=rep(NA,Nskill)
    for(jj in 1:Nskill){
      tmp[Nskill-jj+1]=((ii-1)%/%(2^(jj-1)))%%2
    }
    profile_list[[ii]]=rev(tmp)
  }

  Q=do.call(rbind,lapply(profile_list[-1],function(x)
    do.call(rbind,lapply(1:Nq_per_profile,function(i) x))))

  Nq=dim(Q)[1]

  q_info=generate_q_info(Q)
  interaction_in_profile=q_info$interaction_in_profile
  interaction_qids=q_info$interaction_qids
  interaction_list=q_info$interaction_list
  skill_in_profile=q_info$skill_in_profile
  profile_list=q_info$profile_list
  q_profiles=q_info$q_profiles

  intercepts=stats::rnorm(Nq,mean=-3,sd=.1)
  base_effects=matrix(NA,Nq,Nskill)
  base_effects[-unique(interaction_qids),]=rnorm(Nskill*(Nq-length(unique(interaction_qids))),mean=6,sd=.1)
  base_effects[unique(interaction_qids),]=rnorm(Nskill*length(unique(interaction_qids)),mean=3,sd=.1)
  base_effects[q_profiles==8,]=rnorm(Nskill*sum(q_profiles==8),mean=2,sd=.1)
  interactions=rnorm(length(interaction_qids),mean=0,sd=.1)

  true_attributes=c(sapply(1:Nprofile,function(x) rep(x,Nresp_per_profile)))
  Nz=length(true_attributes)

  true_logits=generate_logit_probabilities_discrete(intercepts,
                                           base_effects,
                                           interactions,
                                           q_info)$logits
  true_probs=logit(true_logits)
  X=t(sapply(true_attributes,function(y) sapply(true_probs[,y],
                                                    function(p) sample(c(0,1),size=1,prob=c(1-p,p)))))


  return(list(X=X,Q=Q,true_attributes=true_attributes))
}



#' Simulate CDM data
#'
#'@param Nskill Number of skills to simulate
#'@param seed Fix seed for reproducibility
#'@return Returns simulated X and Q-matrix
#'@export
simulated_cdm_data_longitudinal<-function(Nskill=3,Nresp_per_profile=20,
           ntime=2,
           Nq_per_profile=3,seed=123){
  if(!is.na(seed)){
    set.seed(seed)
  }
  Nprofile=2^Nskill

  profile_list=list()
  for(ii in 1:(2^Nskill)){
    tmp=rep(NA,Nskill)
    for(jj in 1:Nskill){
      tmp[Nskill-jj+1]=((ii-1)%/%(2^(jj-1)))%%2
    }
    profile_list[[ii]]=rev(tmp)
  }

  Q=do.call(rbind,lapply(profile_list[-1],function(x)
    do.call(rbind,lapply(1:Nq_per_profile,function(i) x))))

  Nq=dim(Q)[1]

  q_info=generate_q_info(Q)
  interaction_in_profile=q_info$interaction_in_profile
  interaction_qids=q_info$interaction_qids
  interaction_list=q_info$interaction_list
  skill_in_profile=q_info$skill_in_profile
  profile_list=q_info$profile_list
  q_profiles=q_info$q_profiles

  intercepts=stats::rnorm(Nq,mean=-3,sd=.1)
  base_effects=matrix(NA,Nq,Nskill)
  base_effects[-unique(interaction_qids),]=rnorm(Nskill*(Nq-length(unique(interaction_qids))),mean=6,sd=.1)
  base_effects[unique(interaction_qids),]=rnorm(Nskill*length(unique(interaction_qids)),mean=3,sd=.1)
  base_effects[q_profiles==8,]=rnorm(Nskill*sum(q_profiles==8),mean=2,sd=.1)
  interactions=rnorm(length(interaction_qids),mean=0,sd=.1)

  true_attributes=c(sapply(1:Nprofile,function(x) rep(x,Nresp_per_profile)))
  Nz=length(true_attributes)

  Xs=list()
  for(t in 1:ntime){
    true_logits=generate_logit_probabilities_continuous(intercepts,
                                                        base_effects,
                                                        interactions,
                                                        q_info)$logits
    true_probs=logit(true_logits)
    Xs[[t]]=t(sapply(true_attributes,function(y) sapply(true_probs[,y],
                                                   function(p) sample(c(0,1),size=1,prob=c(1-p,p)))))
  }
  design_mat=cbind(1,rnorm(Nz))
  Xdata=list(Xs=Xs,design_mat=design_mat)
  return(list(Xdata=Xdata,Q=Q,true_attributes=true_attributes))
}
