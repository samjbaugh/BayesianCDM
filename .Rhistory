maxiter=100
#minimize the ELBO
optout=optim(paramvec,ELBO_wrapper,control=list(maxit=maxiter))
paramvec=convert_params_to_vector(initial_params)
init_vb_vec=c(convert_params_to_vector(initial_params),rep(1,length(paramvec)))
variational_vec=cbind()
ELBO_wrapper=function(vec){
cdm_ELBO(vec,Xdata,paraminfo,Q,nsamples=5)
}
ELBO_wrapper(init_vb_vec)
paramvec=convert_params_to_vector(initial_params)
init_vb_vec=c(convert_params_to_vector(initial_params),rep(1,length(paramvec)))
variational_vec=cbind()
ELBO_wrapper=function(vec){
cdm_ELBO(vec,Xdata,paraminfo,Q,nsamples=5)
}
#minimize the ELBO
ELBO_wrapper(vb_vec)
optout=optim(vb_vec,ELBO_wrapper,control=list(maxit=maxiter))
optout=optim(vb_vec,ELBO_wrapper,control=list(maxit=maxiter,trace=6))
ELBO_wrapper=function(vec){
cdm_ELBO(vec,Xdata,paraminfo,Q,nsamples=1)
}
ELBO_wrapper(vb_vec)
optout=optim(vb_vec,ELBO_wrapper,control=list(maxit=maxiter,trace=6))
paramvec=convert_params_to_vector(initial_params)
init_vb_vec=c(convert_params_to_vector(initial_params),rep(.1,length(paramvec)))
variational_vec=cbind()
ELBO_wrapper=function(vec){
cdm_ELBO(vec,Xdata,paraminfo,Q,nsamples=5)
}
ELBO_wrapper(vb_vec)
optout=optim(vb_vec,ELBO_wrapper,control=list(maxit=maxiter,trace=6))
optout
optout=optim(vb_vec,ELBO_wrapper,control=list(maxit=1000,trace=6))
optout
paramvec=convert_params_to_vector(initial_params)
init_vb_vec=c(convert_params_to_vector(initial_params),rep(.1,length(paramvec)))
variational_vec=cbind()
ELBO_wrapper=function(vec){
cdm_ELBO(vec,Xdata,paraminfo,Q,nsamples=5)
}
ELBO_wrapper(vb_vec)
variational_out=optout$par
npar=length(variational_out)/2
vb_out=list(vb_mean=optout$par[1:npar],vb_var=optout$par[(npar+1):(2*npar)])
variational_out=optout$par
variational_out=vb_out
variational_out
a=variational_out$vb_mean
a=data.frame(variational_out$vb_mean)
a
a=data.frame(t(variational_out$vb_mean))
a
a=data.frame(t(variational_out$vb_mean))%>%
pivot_wider()
a
variational_out$vb_mean
cbind(variational_out$vb_mean,variational_out$vb_var)
rbind(variational_out$vb_mean,variational_out$vb_var)
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
pivot_longer(everything())
a
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))
help(pivot_longer)
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var)%>%mutate(type=c('mean','var')))%>%
pivot_longer(!'type')
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type')
a
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer('type')
a
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))#%>%
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer()
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(everything())
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type')
a
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type')%>%
pivot_wider(type)
a
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type')%>%
pivot_wider(c(type,name))
a
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type')%>%
pivot_wider(name)
a
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type')
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type')%>%
pivot_wider(type)
a
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type')
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(everything())
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type')
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type')%>%
nest(name)
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='a')%>%
nest(name)
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='a')%>%
nest(a)
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='a')
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='a')%>%
group_by(a)%>%
nest()
a
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='data')%>%
group_by(data)%>%
nest()
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()
a
a$data[[1]]
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
mutate(data=map(data,~rnorm(1000,.[1,2],.[2,2])))
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
rowwise()%>%
mutate(data=map(data,~rnorm(1000,.[1,2],.[2,2])))
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()#%>%
a$data
a$data[[1]]
map(a$data,~.[1,2])
map(a$data,~.[2,2])
map(a$data)
a$data
# rowwise()%>%
mutate(data=map(data,~rnorm(1000,.$value[1],.$value[2])))
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~rnorm(1000,.$value[1],.$value[2])))
a
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~rnorm(1000,.$value[1],.$value[2])))%>%
unnest
a=data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~rnorm(1000,.$value[1],.$value[2])))%>%
unnest(data)
# %>%
a
variationa_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~rnorm(1000,.$value[1],.$value[2])))%>%
unnest(data)
names(variationa_resamp)[c(1:4,22:23,30:32+60,94:97,107:110+5,130:133)]
names(variational_resamp)[c(1:4,22:23,30:32+60,94:97,107:110+5,130:133)]
variational_resamp
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~rnorm(1000,.$value[1],.$value[2])))%>%
unnest(data)
variational_resamp
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~rnorm(1000,.$value[1],.$value[2])))%>%
unnest_longer(data)
variational_resamp
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~rnorm(1000,.$value[1],.$value[2])))%>%
unnest_wider(data)
variational_resamp
variational_resamp
a
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~rnorm(1000,.$value[1],.$value[2])))%>%
unnest_wider(d)
variational_resamp
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~rnorm(1000,.$value[1],.$value[2])))%>%
unnest_wider(data)
variational_resamp
t(variational_resamp)
variational_resamp
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~rnorm(1000,.$value[1],.$value[2])))%>%
unnest_longer(data)
variational_resamp
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~rnorm(1000,.$value[1],.$value[2])))%>%
unnest_wider(data)
transpose(variational_resamp)
spread
sperad(variational_resamp)
spread(variational_resamp)
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~rnorm(1000,.$value[1],.$value[2])))%>%
pivot_wider(names_from=d)
variational_resamp
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~rnorm(1000,.$value[1],.$value[2])))
variational_resamp
pivot_wider(variational_resamp,names_from=d)
pivot_wider(variational_resamp,names_from=d,id_cols=data)
pivot_wider(variational_resamp,names_from=d,id_cols=everything)
pivot_wider(variational_resamp,names_from=d,id_cols=everything())
pivot_wider(variational_resamp,names_from='d',id_cols=everything())
pivot_wider(variational_resamp,names_from=d)
variational_resamp%>%
unnest()
variational_resamp%>%
unnest(data)
variational_resamp%>%
unnest(data)%>%
pivot_wider(names_from=d)
variational_resamp%>%
unnest(data)%>%
pivot_wider(names_from='d')
variational_resamp%>%
unnest(data)%>%
pivot_wider(names_from=d,id_cols=d)
variational_resamp%>%
unnest(data)%>%
pivot_wider(id_cols=d)
variational_resamp
help(pivot_wider)
variational_resamp%>%
unnest(data)%>%
pivot_wider(names_from=d,values_from=data)
variational_resamp%>%
unnest(data)
variational_resamp%>%
unnest(data)%>%
pivot_wider(names_from=d,values_from=data)
variational_resamp%>%
unnest(data)%>%
pivot_wider(names_from=d,values_from=data)
variational_resamp
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~data.frame(i=1:1000,vals=rnorm(1000,.$value[1],.$value[2]))))%>%
pivot_wider(names_from=d)
variational_resamp%>%
unnest(data)%>%
pivot_wider(names_from=d,values_from=data)
variational_resamp
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~data.frame(i=1:1000,vals=rnorm(1000,.$value[1],.$value[2]))))
variational_resamp
variational_resamp%>%
unnest(data)
variational_resamp%>%
unnest(data)%>%
pivot_wider(names_from=d,values_from=data)
# pivot_wider(names_from=d)
variational_resamp%>%
unnest(data)%>%
pivot_wider(names_from=d,values_from=vals)
names(variational_resamp)[1+c(1:4,22:23,30:32+60,94:97,107:110+5,130:133)]
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~data.frame(i=1:1000,vals=rnorm(1000,.$value[1],.$value[2]))))%>%
unnest(data)%>%
pivot_wider(names_from=d,values_from=vals)
names(variational_resamp)[1+c(1:4,22:23,30:32+60,94:97,107:110+5,130:133)]
plotdf=variationa_resamp[1001:2000,c(1:4,22:23,30:31+60,94:97,107:110+5,130:133)]%>%
pivot_longer(everything())%>%
mutate(type=map_chr(name,~strsplit(.,'_')[[1]][1]))
plotdf=variationa_resamp[1001:2000,1+c(1:4,22:23,30:31+60,94:97,107:110+5,130:133)]%>%
pivot_longer(everything())%>%
mutate(type=map_chr(name,~strsplit(.,'_')[[1]][1]))
plotdf=variationa_resamp[,1+c(1:4,22:23,30:31+60,94:97,107:110+5,130:133)]%>%
pivot_longer(everything())%>%
mutate(type=map_chr(name,~strsplit(.,'_')[[1]][1]))
variational_resamp
variational_resamp[,1+c(1:4,22:23,30:31+60,94:97,107:110+5,130:133)]
plotdf=variational_resamp[,1+c(1:4,22:23,30:31+60,94:97,107:110+5,130:133)]%>%
pivot_longer(everything())%>%
mutate(type=map_chr(name,~strsplit(.,'_')[[1]][1]))
plotdf=mcmc_samples[1001:2000,c(1:4,22:23,30:31+60,94:97,107:110+5,130:133)]%>%
pivot_longer(everything())%>%
mutate(type=map_chr(name,~strsplit(.,'_')[[1]][1]))
ggplot(plotdf) +
geom_histogram(aes(x = value,fill=type), bins = 15) +
facet_wrap(~ name)
names(variational_resamp)[1+c(1:4,22:23,30:32+60,94:97,107:110+5,130:133)]
plotdf=variational_resamp[,1+c(1:4,22:23,30:31+60,94:97,107:110+5,130:133)]%>%
pivot_longer(everything())%>%
mutate(type=map_chr(name,~strsplit(.,'_')[[1]][1]))
ggplot(plotdf) +
geom_histogram(aes(x = value,fill=type), bins = 15) +
facet_wrap(~ name)
variational_fit=function(initial_params,maxiter=100){
paramvec=convert_params_to_vector(initial_params)
init_vb_vec=c(convert_params_to_vector(initial_params),rep(.1,length(paramvec)))
variational_vec=cbind()
ELBO_wrapper=function(vec){
cdm_ELBO(vec,Xdata,paraminfo,Q,nsamples=5)
}
ELBO_wrapper(vb_vec)
optout=optim(vb_vec,ELBO_wrapper,control=list(maxit=1000,trace=6))
npar=length(init_vb_vec)/2
return(list(vb_mean=optout$par[1:npar],vb_var=optout$par[(npar+1):(2*npar)]))
}
source("~/Dropbox/MJProjects/CogDiagModels/cdmfits/R/fit_variational.R", echo=TRUE)
variational_out=variational_fit(initial_params,maxiter=100)
tvar=system.time({variational_out=variational_fit(initial_params,maxiter=100)})
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~data.frame(i=1:10000,vals=rnorm(10000,.$value[1],.$value[2]))))%>%
unnest(data)%>%
pivot_wider(names_from=d,values_from=vals)
names(variational_resamp)[1+c(1:4,22:23,30:32+60,94:97,107:110+5,130:133)]
plotdf=variational_resamp[,1+c(1:4,22:23,30:31+60,94:97,107:110+5,130:133)]%>%
pivot_longer(everything())%>%
mutate(type=map_chr(name,~strsplit(.,'_')[[1]][1]))
ggplot(plotdf) +
geom_histogram(aes(x = value,fill=type), bins = 15) +
facet_wrap(~ name)
ggplot(plotdf) +
geom_histogram(aes(x = value,fill=type), bins = 20) +
facet_wrap(~ name)
ggplot(plotdf) +
geom_density(aes(x = value,fill=type)) +
facet_wrap(~ name)
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~data.frame(i=1:100000,vals=rnorm(100000,.$value[1],.$value[2]))))%>%
unnest(data)%>%
pivot_wider(names_from=d,values_from=vals)
names(variational_resamp)[1+c(1:4,22:23,30:32+60,94:97,107:110+5,130:133)]
plotdf=variational_resamp[,1+c(1:4,22:23,30:31+60,94:97,107:110+5,130:133)]%>%
pivot_longer(everything())%>%
mutate(type=map_chr(name,~strsplit(.,'_')[[1]][1]))
ggplot(plotdf) +
geom_density(aes(x = value,fill=type)) +
facet_wrap(~ name)
source("~/Dropbox/MJProjects/CogDiagModels/cdmfits/R/fit_variational.R", echo=TRUE)
source("~/Dropbox/MJProjects/CogDiagModels/cdmfits/R/fit_variational.R", echo=TRUE)
tvar=system.time({variational_out=variational_fit(initial_params,maxiter=100)})
variational_out=optout$par
nresamp=1000
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~data.frame(i=1:nresamp,vals=rnorm(nresamp,.$value[1],.$value[2]))))%>%
unnest(data)%>%
pivot_wider(names_from=d,values_from=vals)
names(variational_resamp)[1+c(1:4,22:23,30:32+60,94:97,107:110+5,130:133)]
plotdf=variational_resamp[,1+c(1:4,22:23,30:31+60,94:97,107:110+5,130:133)]%>%
pivot_longer(everything())%>%
mutate(type=map_chr(name,~strsplit(.,'_')[[1]][1]))
ggplot(plotdf) +
geom_density(aes(x = value,fill=type)) +
facet_wrap(~ name)
variational_out
variational_out=optout$par
nresamp=1000
variational_resamp=
data.frame(rbind(variational_out$vb_mean,variational_out$vb_var))%>%
mutate(type=c('mean','var'))%>%
pivot_longer(!'type',names_to='d')%>%
group_by(d)%>%
nest()%>%
# rowwise()%>%
mutate(data=map(data,~data.frame(i=1:nresamp,vals=rnorm(nresamp,.$value[1],.$value[2]))))%>%
unnest(data)%>%
pivot_wider(names_from=d,values_from=vals)
variational_out
tvar
1844.955/60
